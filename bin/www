#!/usr/bin/env node
var debug = require('debug')('gazzetta');
var app = require('../app');
var config = require('../config.js');
var model = require('../models.js');

if (app.get('env') === 'production') {
  app.set('host', config.production.host);
  app.set('port', config.production.port);
} else {
  app.set('host', config.dev.host);
  app.set('port', config.dev.port);
}

var server = app.listen(app.get('port'), app.get('host'), function() {
  debug('Express server listening on port ' + server.address().port);
});

var Player = model.Player;
var Rating = model.Rating;
var Opinion = model.Opinion;
var Summary = model.Summary;
var Mom = model.Mom;
var io = require('socket.io')(server);

var groupId = 1;
io.on('connection', function(socket) {

  emitBaseInfo(socket);

  socket.on('post rating', function(data) {
    updateRating(data);
    broadcastBaseInfo();
  });

  socket.on('post mom', function(data) {
    updateMom(data);
    broadcastBaseInfo();
  });

  socket.on('post summary', function(data) {
    insertSummaryComment(data);
    broadcastBaseInfo();
  });

});

function emitBaseInfo(socket) {
  Player.find({ group: groupId }).exec(function(err, players) {
    Rating.find({ group: groupId }).exec(function(err, ratings) {
      Opinion.find({ group: groupId }).exec(function(err, opinions) {
        Summary.find({ group: groupId }).exec(function(err, summaries) {
          Mom.find({ group: groupId }).exec(function(err, moms) {
            socket.emit('login', { players: players, ratings: ratings, opinions: opinions, summaries: summaries, moms: moms, group: groupId });
          });
        });
      });
    });
  });
}

function broadcastBaseInfo() {
  Player.find({ group: groupId }).exec(function(err, players) {
    Rating.find({ group: groupId }).exec(function(err, ratings) {
      Opinion.find({ group: groupId }).exec(function(err, opinions) {
        Summary.find({ group: groupId }).exec(function(err, summaries) {
          Mom.find({ group: groupId }).exec(function(err, moms) {
            io.sockets.emit('broadcast results', { players: players, ratings: ratings, opinions: opinions, summaries: summaries, moms: moms, group: groupId });
          });
        });
      });
    });
  });
}

function updateRating(data) {
  var id = data.id;
  var formatedRating = parseFloat(data.rating);
  var opinion = data.opinion;
  Rating.findOne({ id: data.id }, function(err, rating) {
    if (rating === null) {
      var newRecord = new Rating({ id: id, group: groupId, sum: formatedRating, num: 1 });
      newRecord.save(function(err) {

      });
    } else {
      rating.num = rating.num + 1;
      rating.sum = rating.sum + formatedRating;
      rating.save();
    }
    if (opinion.length > 0) {
      var newOpinion = new Opinion({ id: id, group: groupId, opinion: opinion, createdAt: getUnixTime() });
      newOpinion.save(function(err) {

      });
    }
  });
}

function insertSummaryComment(data) {
  var comment = data.comment;
  var group = data.group;
  if (comment.length > 0) {
    var newSummary = new Summary({ group: group, comment: comment, createdAt: getUnixTime() });
    newSummary.save(function(err) {

    });
  }
}

function updateMom(data) {
  Mom.findOne({ id: data.id }, function(err, mom) {
    if (mom === null) {
      var newRecord = new Mom({id: data.id, num: 1, group: data.group});
      newRecord.save(function(err) {

      });
    } else {
      mom.num = mom.num + 1;
      mom.save();
    }
  });
}

function getUnixTime() {
   return parseInt((new Date)/1000);
}

